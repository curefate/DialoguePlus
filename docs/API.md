# API Reference

This document provides API reference for the high-level modules in DialoguePlus.Core that are useful for developers integrating the library.

**This file is generated by Claude.**

## DialoguePlus.Core.Compiler

The main compiler for DialoguePlus scripts (.dp files). Compiles source files into executable label sets and manages symbol tables.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public static | Version | string | Gets the current version of the DialoguePlus compiler |
| public | SymbolTables | SymbolTableManager | Gets the symbol table manager containing symbol information for all compiled files |

### Methods

| Access | Signature | Description |
|:-------|:----------|:------------|
| public | `Compiler(IContentResolver? resolver = null)` | Initializes a new compiler instance. If no resolver is provided, uses default file and cache providers |
| public | `CompileResult Compile(string pathOrUri)` | Compiles a DialoguePlus script file from a file path or URI. Returns a CompileResult with status, diagnostics, and compiled label set |

### Example

```csharp
var compiler = new Compiler();
var result = compiler.Compile("path/to/script.dp");
if (result.Success)
{
    // Use result.Labels for execution
}
else
{
    // Check result.Diagnostics for errors
}
```

## DialoguePlus.Core.CompileResult

Represents the result of a compilation operation.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Success | bool | Whether the compilation was successful (no errors) |
| public | Diagnostics | List\<Diagnostic\> | List of diagnostics (errors, warnings, info) generated during compilation |
| public | Labels | LabelSet | The compiled label set containing all executable labels and statements |
| public | SourceID | string | The source ID (URI) of the main compiled file |
| public | Timestamp | long | Unix timestamp (milliseconds) when the compilation was performed |

## DialoguePlus.Core.IContentProvider

Interface for content providers that can load source files from different sources (file system, cache, HTTP, etc.).

### Methods

| Access | Signature | Description |
|:-------|:----------|:------------|
| public | `bool CanHandle(Uri uri)` | Determines whether this provider can handle the specified URI scheme |
| public | `Task<bool> ExistsAsync(Uri uri, CancellationToken ct = default)` | Checks whether a source file exists at the specified URI |
| public | `Task<SourceContent> OpenTextAsync(Uri uri, CancellationToken ct = default)` | Opens and reads the text content from the specified URI |

### Built-in Implementations

- **FileContentProvider**: Loads files from the local file system
- **CacheContentProvider**: Provides in-memory caching of source content

## DialoguePlus.Core.LabelSet

A collection of compiled labels that can be executed by the Executer.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public static | DefaultEntranceLabel | string | The default entrance label name for top-level statements (`@system/__main__`) |
| public | Labels | Dictionary\<string, SIR_Label\> | Dictionary of all labels in this set, keyed by label name |
| public | EntranceLabel | string | The entrance label name for execution. Defaults to DefaultEntranceLabel |

## DialoguePlus.Core.SIR

Base class for all Structured Intermediate Representation (SIR) instructions. SIR is the compiled form of DialoguePlus scripts.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Line | int | Source line number where this instruction was defined |
| public | Column | int | Source column number where this instruction was defined |

### SIR_Label

Represents a label definition containing a block of statements.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | LabelName | string | The name of this label |
| public | SourceID | string | The source ID (URI) where this label was defined |
| public | Statements | List\<SIR\> | The list of statements in this label block |

### SIR_Dialogue

Represents a dialogue statement with optional speaker and text content.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Speaker | string | The speaker name for this dialogue (empty if no speaker) |
| public | Text | FStringNode | The formatted text content of the dialogue |

### SIR_Menu

Represents a menu (choice) statement with multiple options and corresponding code blocks.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Options | List\<FStringNode\> | The list of option texts displayed to the user |
| public | Blocks | List\<List\<SIR\>\> | The list of code blocks corresponding to each option |

### SIR_Jump

Represents a jump instruction that transfers control to another label. Clears the execution queue and resets the variable scope.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | TargetLabel | string | The target label name to jump to |

### SIR_Call

Represents a function call instruction.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | FunctionName | string | The name of the function to call |
| public | Arguments | List\<DPExpression\> | The list of argument expressions to pass to the function |

### SIR_Assign

Represents an assignment or expression evaluation instruction.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Expression | DPExpression | The expression to evaluate (may include variable assignments) |

### SIR_If

Represents a conditional (if-else) instruction.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Condition | DPExpression | The condition expression that must evaluate to a boolean |
| public | ThenBlock | List\<SIR\> | The list of statements to execute if the condition is true |
| public | ElseBlock | List\<SIR\> | The list of statements to execute if the condition is false |

## DialoguePlus.Core.Runtime

Manages runtime state including variables and function registries for dialogue execution.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Variables | VariableRegistry | The variable registry for storing and accessing script variables |
| public | Functions | FunctionRegistry | The function registry for registering and calling C# functions from scripts |

### VariableRegistry

Manages variable storage with support for global and temporary (scoped) variables.

#### Properties

Variables are accessed via methods rather than properties.

#### Methods

| Access | Signature | Description |
|:-------|:----------|:------------|
| public | `void Clear()` | Clears all variables in both global and temporary scopes |
| public | `void NewTempScope()` | Creates a new temporary variable scope. Used when entering a new context (e.g., tour to a label) |
| public | `void PopTempScope()` | Pops the current temporary variable scope, discarding all variables in it |
| public | `void Set(string varName, object value)` | Sets a variable value. Variables starting with "global." are stored in the global scope. Supported types: string, int, float, bool |
| public | `TypedVar Get(string varName)` | Gets the value of a variable. Variables starting with "global." are retrieved from the global scope |

#### Example

```csharp
runtime.Variables.Set("playerName", "Alice");
runtime.Variables.Set("global.score", 100);
var name = runtime.Variables.Get("playerName");
```

### FunctionRegistry

Manages registration and invocation of C# functions that can be called from DialoguePlus scripts.

#### Methods

| Access | Signature | Description |
|:-------|:----------|:------------|
| public | `void Clear()` | Clears all registered functions |
| public | `void AddFunction<TResult>(Func<TResult> func, string funcName = "")` | Registers a function with no parameters that returns a value |
| public | `void AddFunction<T0, TResult>(Func<T0, TResult> func, string funcName = "")` | Registers a function with one parameter that returns a value |
| public | `void AddFunction<T0, T1, TResult>(Func<T0, T1, TResult> func, string funcName = "")` | Registers a function with two parameters that returns a value |
| public | `void AddFunction<T0, T1, T2, TResult>(Func<T0, T1, T2, TResult> func, string funcName = "")` | Registers a function with three parameters that returns a value |
| public | `void AddFunction<T0, T1, T2, T3, TResult>(Func<T0, T1, T2, T3, TResult> func, string funcName = "")` | Registers a function with four parameters that returns a value |
| public | `void AddFunction<T0, T1, T2, T3, T4, TResult>(Func<T0, T1, T2, T3, T4, TResult> func, string funcName = "")` | Registers a function with five parameters that returns a value |
| public | `void AddFunction(Action action, string funcName = "")` | Registers an action (void function) with no parameters |
| public | `void AddFunction<T0>(Action<T0> action, string funcName = "")` | Registers an action with one parameter |
| public | `void AddFunction<T0, T1>(Action<T0, T1> action, string funcName = "")` | Registers an action with two parameters |
| public | `void AddFunction<T0, T1, T2>(Action<T0, T1, T2> action, string funcName = "")` | Registers an action with three parameters |
| public | `void AddFunction<T0, T1, T2, T3>(Action<T0, T1, T2, T3> action, string funcName = "")` | Registers an action with four parameters |
| public | `void AddFunction<T0, T1, T2, T3, T4>(Action<T0, T1, T2, T3, T4> action, string funcName = "")` | Registers an action with five parameters |
| public | `void AddFunction(Delegate func, string funcName)` | Registers a generic delegate with a custom name |
| public | `Delegate GetDelegate(string funcName)` | Gets the delegate for a registered function |
| public | `dynamic? Invoke(string funcName, params object[] args)` | Invokes a function with dynamic arguments. Returns the function result or null for void functions |

#### Example

```csharp
runtime.Functions.AddFunction(() => Random.Shared.Next(1, 7), "rollDice");
runtime.Functions.AddFunction((string msg) => Console.WriteLine(msg), "log");
runtime.Functions.Invoke("log", "Hello from DialoguePlus!");
```

### TypedVar

Represents a typed variable with its value and type information.

#### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Value | object | The value of the variable |
| public | Type | Type | The type of the variable |

## DialoguePlus.Core.Executer

Executes compiled DialoguePlus scripts by processing SIR (Structured Intermediate Representation) instructions.

### Properties

| Access | Name | Type | Description |
|:-------|:-----|:-----|:------------|
| public | Runtime | Runtime | The runtime instance managing variables and functions for this executer |
| public | HasNext | bool | Whether there are more instructions to execute in the queue |
| public | OnDialogueAsync | Func\<Runtime, SIR_Dialogue, Task\> | Callback invoked when a dialogue statement is executed. Default implementation prints to console |
| public | OnMenuAsync | Func\<Runtime, SIR_Menu, Task\<int\>\> | Callback invoked when a menu statement is executed. Should return the zero-based index of the selected option. Default implementation reads from console |

### Methods

| Access | Signature | Description |
|:-------|:----------|:------------|
| public | `Executer(Runtime? runtime = null)` | Initializes a new executer instance. If no runtime is provided, creates a new one |
| public | `void Prepare(LabelSet set)` | Prepares a label set for execution by loading it and initializing the execution queue |
| public | `Task<bool> StepAsync(CancellationToken ct = default)` | Executes the next instruction in the queue. Returns true if there are more instructions; false if empty |
| public | `Task AutoStepAsync(int mode = 0, CancellationToken ct = default)` | Automatically steps through execution. Mode 0: runs to completion. Mode 1: stops at dialogue/menu/call |
| public | `SIR? Peek()` | Peeks at the next instruction in the queue without removing it |

### Example

```csharp
var compiler = new Compiler();
var result = compiler.Compile("script.dp");

if (result.Success)
{
    var executer = new Executer();
    
    // Set custom callbacks
    executer.OnDialogueAsync = async (runtime, dialogue) =>
    {
        var speaker = dialogue.Speaker;
        var text = dialogue.Text.Evaluate(runtime);
        await DisplayDialogue(speaker, text);
    };
    
    executer.OnMenuAsync = async (runtime, menu) =>
    {
        var options = menu.Options.Select(opt => opt.Evaluate(runtime)).ToList();
        return await ShowMenu(options);
    };
    
    // Execute
    executer.Prepare(result.Labels);
    while (executer.HasNext)
    {
        await executer.StepAsync();
    }
}
```
